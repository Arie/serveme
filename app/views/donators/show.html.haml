- content_for(:title) { "Donator: #{@user.nickname}" }

.row
  .col-md-12
    .d-flex.justify-content-between.align-items-center.mb-4
      %h2.mb-0= link_to "Donators", donators_path, class: "text-decoration-none"

.row
  .col-md-4
    .card.mb-4
      .card-header
        %h5.mb-0.text-white User Information
      .card-body
        .text-center.mb-3
          %img.rounded-circle{src: @user.steam_avatar_url(:full), width: "120", height: "120", alt: @user.nickname}
        
        %h4.text-center= @user.nickname
        
        %dl.row.mt-3
          %dt.col-sm-5 User ID:
          %dd.col-sm-7= "##{@user.id}"
          
          %dt.col-sm-5 Steam ID64:
          %dd.col-sm-7
            %code= @user.uid
          
          %dt.col-sm-5 Joined:
          %dd.col-sm-7= l(@user.created_at, format: :long)
          
          %dt.col-sm-5 Status:
          %dd.col-sm-7
            - if @user.donator?
              %span.badge.bg-success.text-white Donator
            - else
              %span.badge.bg-secondary Not a donator
        
        .mt-3
          = link_to "View Steam Profile", @user.steam_profile_url, target: "_blank", rel: "noopener", class: "btn btn-primary btn-block mb-2"
          - if @user.donator?
            = link_to edit_donator_path(@user), class: "btn btn-warning btn-block" do
              %i.fa.fa-pencil.me-2
              Edit Expiration

    .card.mb-4
      .card-header
        %h5.mb-0.text-white Statistics
      .card-body
        %dl.row.mb-0
          %dt.col-sm-7 Lifetime Value:
          %dd.col-sm-5.text-end
            %strong= number_to_currency(@lifetime_value)
          
          %dt.col-sm-7 Total Donations:
          %dd.col-sm-5.text-end= @total_donations
          
          %dt.col-sm-7 Total Reservations:
          %dd.col-sm-5.text-end
            = link_to @total_reservations, user_reservations_path(@user), class: "text-decoration-none"
          
          %dt.col-sm-7 Total Hours:
          %dd.col-sm-5.text-end= "#{@total_reservation_hours}h"

  .col-md-8
    .card.mb-4
      .card-header
        .d-flex.justify-content-between.align-items-center
          %h5.mb-0.text-white Donator Status History
          - if @donator_periods.any? && @total_donator_time
            %span.badge.bg-info.text-white
              Total: #{@total_donator_time} as donator
      .card-body
        - if @donator_periods.any?
          .table-responsive
            %table.table.table-sm.mb-0
              %thead
                %tr
                  %th Started
                  %th Expires
                  %th Duration
                  %th Status
              %tbody
                - @donator_periods.each do |period|
                  %tr
                    %td= l(period.created_at, format: :long)
                    %td
                      - if period.expires_at
                        = l(period.expires_at, format: :long)
                      - else
                        %span.text-muted Never
                    %td
                      - if period.expires_at
                        = format_exact_duration(period.created_at, period.expires_at)
                      - else
                        %span.text-muted Permanent
                    %td
                      - if period.expires_at && period.expires_at < Time.current
                        %span.badge.bg-secondary.text-white Expired
                      - elsif period.expires_at && period.expires_at < 7.days.from_now
                        %span.badge.bg-warning.text-dark Expiring Soon
                      - else
                        %span.badge.bg-success.text-white Active
        - else
          %p.text-muted.mb-0 No donator history

    .card
      .card-header
        .d-flex.justify-content-between.align-items-center
          %h5.mb-0.text-white Donation History
          %span.badge.bg-primary= "#{@orders.count} total"
      .card-body
        - if @orders.any?
          .table-responsive
            %table.table.table-sm.mb-0
              %thead
                %tr
                  %th Date
                  %th Product
                  %th Amount
                  %th Gift Status
                  %th Type
                  %th
              %tbody
                - @orders.each do |order|
                  %tr
                    %td= l(order.created_at, format: :long)
                    %td= order.product_name
                    %td= number_to_currency(order.product&.price || 0)
                    %td
                      - if order.gift?
                        - if order.voucher&.claimed?
                          %span.badge.bg-success.text-white
                            Redeemed by 
                            = link_to order.voucher.claimed_by.nickname, donator_path(order.voucher.claimed_by), class: "text-white text-decoration-underline"
                        - else
                          %span.badge.bg-warning.text-dark Gift (Not Redeemed)
                      - else
                        %span.badge.bg-secondary.text-white Not a Gift
                    %td
                      - if order.is_a?(PaypalOrder)
                        %span.badge.bg-info.text-white PayPal
                      - elsif order.is_a?(StripeOrder)
                        %span.badge.bg-info.text-white Stripe
                      - else
                        %span.badge.bg-secondary.text-white Unknown
                    %td.text-center
        - else
          %p.text-muted.mb-0 No donation history

    .card.mt-4
      .card-header
        .d-flex.justify-content-between.align-items-center
          %h5.mb-0.text-white Gift Redemption History
          %span.badge.bg-primary= "#{@redeemed_gifts.count} total"
      .card-body
        - if @redeemed_gifts.any?
          .table-responsive
            %table.table.table-sm.mb-0
              %thead
                %tr
                  %th Redeemed Date
                  %th Product
                  %th Amount
                  %th Gift From
                  %th Type
              %tbody
                - @redeemed_gifts.each do |voucher|
                  %tr
                    %td= l(voucher.claimed_at, format: :long)
                    %td= voucher.product.name
                    %td= number_to_currency(voucher.product.price)
                    %td
                      = link_to voucher.order.user.nickname, donator_path(voucher.order.user), class: "text-decoration-none"
                    %td
                      - if voucher.order.is_a?(PaypalOrder)
                        %span.badge.bg-info.text-white PayPal
                      - elsif voucher.order.is_a?(StripeOrder)
                        %span.badge.bg-info.text-white Stripe
                      - else
                        %span.badge.bg-secondary.text-white Unknown
        - else
          %p.text-muted.mb-0 No gifts redeemed

:javascript
  document.addEventListener('turbo:load', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  })